---
# RedHat related OSs
- name: Yum install {{ item }}
  yum:
    name: "{{ item }}"
    state: present
  with_items:
  - wget
  - tar
  - gzip
  - java-1.8.0-openjdk
  when: "ansible_os_family == 'RedHat'"

- name: Ubuntu install software-properties-common
  apt:
    name: software-properties-common
  when: ansible_distribution == "Ubuntu"

- name: Ubuntu 14 install OpenJDK PPA repo
  apt_repository:
    repo: 'ppa:openjdk-r/ppa'
  when: ansible_distribution == "Ubuntu"

# Debian related OSs
- name: "Apt install requirements"
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
  - wget
  - tar
  - gzip
  - openjdk-8-jre-headless
  - openjdk-8-jdk-headless  # for jps
  when: "ansible_os_family == 'Debian'"

- name: Check that the hadoop home not exists
  stat:
    path: "{{ hadoop_home }}"
  register: hadoop_home_stat_result

- name: Get hadoop tar.gz
  get_url:
    url: "{{ hadoop_mirrors | random }}/hadoop-{{ hadoop_version }}/hadoop-{{ hadoop_version }}.tar.gz"
    dest: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
  register: result
  until: result is succeeded
  retries: 5
  delay: 1
  when:
    - hadoop_home_stat_result.stat.exists == False

- name: Check that the hadoop tar.gz exists
  stat:
    path: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
  register: stat_result
  failed_when: stat_result.stat.exists == False
  when:
    - hadoop_home_stat_result.stat.exists == False

- name: Unzip hadoop tar.gz
  unarchive: 
    src: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
    dest: /opt
    creates: "/opt/hadoop-{{ hadoop_version }}"
    copy: no
  when:
    - hadoop_home_stat_result.stat.exists == False

- name: Remove hadoop tar.gz
  file:
    path: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
    state: absent
  when:
    - hadoop_home_stat_result.stat.exists == False

- name: Rename folder
  command: "mv /opt/hadoop-{{ hadoop_version }} {{ hadoop_home }}"
  when:
    - hadoop_home_stat_result.stat.exists == False

- name: Remove previous data dir
  file:
    path: "{{ hadoop_home }}/data"
    state: absent

- name: Create data dir
  file:
    path: "{{ hadoop_home }}/data"
    state: directory

- name: Create data namenode dir
  file:
    path: "{{ hadoop_home }}/data/nameNode"
    state: directory

- name: Create data datanode dir
  file:
    path: "{{ hadoop_home }}/data/dataNode"
    state: directory
