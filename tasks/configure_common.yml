---
- name: Compile core-site template
  template:
    src: core-site.xml
    dest: "{{ hadoop_home }}/etc/hadoop/core-site.xml"
    owner: root
    group: root

- name: Compile hdfs-site template
  template:
    src: hdfs-site.xml
    dest: "{{ hadoop_home }}/etc/hadoop/hdfs-site.xml"
    owner: root
    group: root

- name: Compile workers template
  template:
    src: workers
    dest: "{{ hadoop_home }}/etc/hadoop/workers"
    owner: root
    group: root

- name: Compile yarn template
  template:
    src: yarn-site.xml
    dest: "{{ hadoop_home }}/etc/hadoop/yarn-site.xml"
    owner: root
    group: root
  when:
    - yarn == True

- name: Compile mapred template
  template:
    src: mapred-site.xml
    dest: "{{ hadoop_home }}/etc/hadoop/mapred-site.xml"
    owner: root
    group: root
  when:
    - yarn == True

- name: Copy master priv key in master
  copy:
    content: '{{ master_priv_key }}'
    dest: "~/.ssh/id_rsa"
    owner: root
    group: root
    mode: 0600
  when:
    - master_key == True
    - hadoop_node_type == 'master'

- name: Fix master priv key
  script: "tasks/scripts/fix_key.py ~/.ssh/id_rsa"
  when:
    - master_key == True
    - hadoop_node_type == 'master'

- name: Copy master pub key in master
  copy:
    content: '{{ master_pub_key }}'
    dest: "~/.ssh/id_rsa.pub"
    owner: root
    group: root
    mode: 0644
  when:
    - master_key == True
    - hadoop_node_type == 'master'

- name: Copy master pub key in worker
  copy:
    content: '{{ master_pub_key }}'
    dest: "~/.ssh/authorized_keys"
    owner: root
    group: root
    mode: 0600
  when:
    - master_key == True
    - hadoop_node_type == 'worker'


- name: format HDFS
  command: "{{ hadoop_home }}/bin/hdfs namenode -format"
  when: (hadoop_node_type == 'master' and hadoop_node_role == 'all') or (hadoop_node_type == 'master' and hadoop_node_role == 'namenode')
